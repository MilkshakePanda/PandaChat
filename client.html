<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Panda Chat Application</title>
    <style>
    
        textarea {
            display: block;
        }
    
    </style>
</head>
<body>

    <h1 id="title"></h1>    
    
    <div id="chatContainer"></div>

    <form>
     
        <textarea placeholder="Type your message here" name="user_message"></textarea>
        <button>Send Message</button>

    </form>
    
    <script>
        

        // Establish connection with the socket server
        const connection = new WebSocket("ws://localhost:1337", ['echo-protocol'])
        const form       = document.forms[0]
        const pageTitle  = document.querySelector("#title")
        const chatContainer = document.querySelector("#chatContainer")
        const username = prompt("what's your username")

        // On open
        connection.onopen = () => pageTitle.innerHTML = "Connection Established"
            
        // On error
        connection.onerror = (error) => console.log("There was an error of type " + error + " please try again shortly") 

        // On Message
        connection.onmessage = (event) => displayMessage(event.data)

        // When the user submits the form
        form.onsubmit = (event) => sendMessage(event)

        const sendMessage = (event) => {
            event.preventDefault()
            const messageBody = form.elements["user_message"]
            const message = {
                
                user: username,
                body: messageBody.value
            
            }
            connection.send(JSON.stringify(message))
            messageBody.value = ""
        }

        const displayMessage = (message) => {
            const incomingMessage = JSON.parse(message)
            const messageElement = document.createElement("P") // create an html element
            messageElement.innerHTML = incomingMessage.user + " says: " + incomingMessage.body 
            chatContainer.appendChild(messageElement)        // append the fucker to the container
        }

    </script>

</body>
</html>
